# 🚀 关卡上传功能 - 详细部署教程

## 📋 目录

1. [准备工作](#准备工作)
2. [方案选择](#方案选择)
3. [方案 A：Vercel 部署（推荐，最简单）](#方案avercel部署推荐最简单)
4. [方案 B：Supabase 部署（推荐用于生产）](#方案bsupabase部署推荐用于生产)
5. [配置编辑器](#配置编辑器)
6. [测试上传功能](#测试上传功能)
7. [常见问题](#常见问题)

---

## 准备工作

### 1. 确保代码已提交到 GitHub

如果你还没有将代码推送到 GitHub，按以下步骤操作：

```bash
# 1. 初始化 Git（如果还没有）
git init

# 2. 添加所有文件
git add .

# 3. 提交代码
git commit -m "Add level editor with upload feature"

# 4. 在 GitHub 上创建新仓库（如果还没有）
#    访问 https://github.com/new
#    创建仓库，例如命名为 "my-matchgame"

# 5. 添加远程仓库并推送
git remote add origin https://github.com/你的用户名/my-matchgame.git
git branch -M main
git push -u origin main
```

### 2. 检查文件结构

确保你的项目包含以下文件：

```
my-matchgame-main/
├── api/
│   ├── levels.js          # API 端点（基础版）
│   └── levels-supabase.js # API 端点（Supabase版）
├── game.js
├── index.html
├── levels.json
├── package.json
├── vercel.json
└── 其他文件...
```

---

## 方案选择

### 方案对比

| 方案                  | 难度      | 费用 | 数据持久化  | 推荐度          |
| --------------------- | --------- | ---- | ----------- | --------------- |
| **Vercel（基础版）**  | ⭐ 简单   | 免费 | ❌ 内存存储 | ⭐⭐⭐ 适合测试 |
| **Vercel + Supabase** | ⭐⭐ 中等 | 免费 | ✅ 数据库   | ⭐⭐⭐⭐⭐ 推荐 |
| **Netlify**           | ⭐⭐ 中等 | 免费 | 需配置      | ⭐⭐⭐          |

**建议：** 先用方案 A 测试功能，再用方案 B 部署生产环境。

---

## 方案 A：Vercel 部署（推荐，最简单）

### 步骤 1：注册 Vercel 账号

1. **访问 Vercel 官网**

   - 打开浏览器，访问：https://vercel.com
   - 点击右上角的 **"Sign Up"** 或 **"登录"**

2. **选择登录方式**

   - 推荐选择 **"Continue with GitHub"**（使用 GitHub 账号登录）
   - 这样可以直接导入 GitHub 仓库，更方便

3. **授权 Vercel**

   - 点击后会跳转到 GitHub 授权页面
   - 点击 **"Authorize Vercel"** 授权

4. **完成注册**
   - 授权后会自动跳回 Vercel
   - 看到 Vercel 控制台界面即表示注册成功

### 步骤 2：部署项目

1. **进入 Vercel 控制台**

   - 登录后，你会看到 Vercel 的 Dashboard
   - 点击 **"Add New..."** 或 **"New Project"** 按钮

2. **导入 GitHub 仓库**

   - 在 "Import Git Repository" 页面
   - 你会看到你的 GitHub 仓库列表
   - 找到你的 `my-matchgame` 仓库
   - 点击 **"Import"** 按钮

3. **配置项目**

   - **Project Name**: 可以保持默认，或改成你喜欢的名字（例如：`my-matchgame`）
   - **Framework Preset**: 选择 **"Other"** 或保持默认
   - **Root Directory**: 保持默认 `./`
   - **Build Command**: 留空（因为这是纯前端项目）
   - **Output Directory**: 留空或填写 `./`
   - **Install Command**: 留空

4. **环境变量（暂时跳过）**

   - 这一步可以先跳过，后面需要时再配置
   - 点击 **"Deploy"** 按钮

5. **等待部署**

   - Vercel 会自动开始部署
   - 你会看到部署日志
   - 等待约 1-2 分钟，直到看到 **"Ready"** 或 **"Success"**

6. **获取部署地址**
   - 部署成功后，你会看到一个地址
   - 格式类似：`https://my-matchgame-xxx.vercel.app`
   - **复制这个地址，后面会用到！**

### 步骤 3：测试 API

1. **访问 API 端点**

   - 在浏览器中打开：`https://你的项目名.vercel.app/api/levels`
   - 应该能看到 JSON 响应（可能是空数组 `{"success":true,"levels":[]}`）

2. **如果看到 404 错误**
   - 检查 `api/levels.js` 文件是否存在
   - 检查文件路径是否正确
   - 重新部署项目

### 步骤 4：配置编辑器（见下方）

---

## 方案 B：Supabase 部署（推荐用于生产）

### 步骤 1：注册 Supabase 账号

1. **访问 Supabase 官网**

   - 打开：https://supabase.com
   - 点击 **"Start your project"** 或 **"Sign Up"**

2. **选择登录方式**

   - 推荐使用 GitHub 账号登录
   - 点击 **"Continue with GitHub"**

3. **创建组织（Organization）**
   - 首次使用需要创建组织
   - 输入组织名称（例如：你的用户名）
   - 点击 **"Create Organization"**

### 步骤 2：创建 Supabase 项目

1. **新建项目**

   - 在 Supabase Dashboard 中
   - 点击 **"New Project"** 按钮

2. **填写项目信息**

   - **Name**: 输入项目名称（例如：`my-matchgame`）
   - **Database Password**: 设置数据库密码（**记住这个密码！**）
   - **Region**: 选择离你最近的区域（例如：`Southeast Asia (Singapore)`）
   - 点击 **"Create new project"**

3. **等待项目创建**
   - Supabase 会自动创建数据库
   - 等待约 1-2 分钟，直到看到 **"Project is ready"**

### 步骤 3：创建数据库表

1. **进入 SQL Editor**

   - 在左侧菜单中找到 **"SQL Editor"**
   - 点击进入

2. **创建 levels 表**
   - 点击 **"New query"**
   - 复制以下 SQL 代码并粘贴：

```sql
-- 创建关卡表
CREATE TABLE IF NOT EXISTS levels (
  id SERIAL PRIMARY KEY,
  level_data JSONB NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 启用 Row Level Security（可选）
ALTER TABLE levels ENABLE ROW LEVEL SECURITY;

-- 创建策略：允许所有人读取和写入（开发阶段）
-- 生产环境应该限制权限
CREATE POLICY "Allow all operations" ON levels
  FOR ALL
  USING (true)
  WITH CHECK (true);

-- 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_levels_created_at ON levels(created_at);
```

3. **执行 SQL**

   - 点击 **"Run"** 按钮（或按 `Ctrl+Enter`）
   - 应该看到 "Success. No rows returned"

4. **验证表已创建**
   - 在左侧菜单找到 **"Table Editor"**
   - 应该能看到 `levels` 表

### 步骤 4：获取 API 密钥

1. **进入 Settings**

   - 在左侧菜单找到 **"Settings"**（齿轮图标）
   - 点击进入

2. **找到 API 设置**

   - 在 Settings 中找到 **"API"** 选项
   - 点击进入

3. **复制以下信息**
   - **Project URL**: 类似 `https://xxxxx.supabase.co`
   - **anon public key**: 一长串字符（以 `eyJ` 开头）
   - **复制这两个值，后面会用到！**

### 步骤 5：配置 Vercel 环境变量

1. **回到 Vercel 项目**

   - 进入你的 Vercel 项目页面
   - 点击顶部的 **"Settings"** 标签

2. **添加环境变量**

   - 在左侧菜单找到 **"Environment Variables"**
   - 点击进入

3. **添加两个变量**

   **第一个变量：**

   - **Key**: `SUPABASE_URL`
   - **Value**: 粘贴你的 Supabase Project URL
   - **Environment**: 选择 `Production`, `Preview`, `Development`（全选）
   - 点击 **"Save"**

   **第二个变量：**

   - **Key**: `SUPABASE_ANON_KEY`
   - **Value**: 粘贴你的 Supabase anon public key
   - **Environment**: 选择 `Production`, `Preview`, `Development`（全选）
   - 点击 **"Save"**

4. **重新部署项目**
   - 环境变量添加后，需要重新部署才能生效
   - 点击顶部的 **"Deployments"** 标签
   - 找到最新的部署，点击右侧的 **"..."** 菜单
   - 选择 **"Redeploy"**
   - 等待部署完成

### 步骤 6：切换到 Supabase 版本的 API

1. **重命名 API 文件**

   - 在本地项目中，将 `api/levels.js` 重命名为 `api/levels-basic.js`（备份）
   - 将 `api/levels-supabase.js` 重命名为 `api/levels.js`

2. **提交并推送更改**

   ```bash
   git add .
   git commit -m "Switch to Supabase API"
   git push
   ```

3. **Vercel 自动重新部署**
   - Vercel 检测到代码更新后会自动重新部署
   - 等待部署完成

---

## 配置编辑器

### 步骤 1：打开游戏

1. **访问游戏**

   - 打开你的游戏页面（本地或部署后的地址）
   - 点击 **"菜单"** 按钮

2. **进入关卡编辑器**
   - 点击 **"关卡列表"**
   - 在设置区域找到 **"关卡编辑器"** 按钮
   - 点击进入编辑器

### 步骤 2：配置 API 端点

1. **点击"配置 API"按钮**

   - 在编辑器底部找到 **"配置 API"** 按钮
   - 点击它

2. **输入 API 地址**

   - 会弹出输入框
   - 输入你的 API 端点地址：
     - **Vercel 基础版**: `https://你的项目名.vercel.app/api/levels`
     - **Supabase 版**: 同样使用 Vercel 地址（因为 API 在 Vercel 上）
   - 例如：`https://my-matchgame-abc123.vercel.app/api/levels`
   - 点击 **"确定"**

3. **确认配置成功**
   - 会显示 "API 端点已更新！"
   - 配置已保存到浏览器本地存储

### 步骤 3：测试连接（可选）

1. **检查网络**
   - 确保能访问你的 API 地址
   - 在浏览器中打开 API 地址，应该能看到 JSON 响应

---

## 测试上传功能

### 步骤 1：编辑一个关卡

1. **选择关卡**

   - 在编辑器左侧列表中选择任意关卡
   - 例如选择第 1 关

2. **修改关卡**
   - 修改关卡名称（例如：改成 "测试关卡"）
   - 点击 **"保存到内存"**

### 步骤 2：上传关卡

1. **点击"上传到服务器"按钮**

   - 在编辑器底部找到绿色的 **"上传到服务器"** 按钮
   - 点击它

2. **等待上传**

   - 按钮会变成 "上传中..."
   - 等待几秒钟

3. **查看结果**
   - **成功**: 会显示 "✅ 上传成功！已保存 X 个关卡。"
   - **失败**: 会显示错误信息，检查：
     - API 地址是否正确
     - 网络连接是否正常
     - 服务器是否正常运行

### 步骤 3：验证上传（Supabase 用户）

1. **检查数据库**
   - 进入 Supabase Dashboard
   - 打开 **"Table Editor"**
   - 选择 `levels` 表
   - 应该能看到你上传的关卡数据

---

## 常见问题

### Q1: 部署后访问 API 返回 404

**解决方案：**

1. 检查 `api/levels.js` 文件是否存在
2. 检查文件路径是否正确（应该在 `api/` 目录下）
3. 检查 `vercel.json` 配置是否正确
4. 重新部署项目

### Q2: 上传时提示 "CORS 错误"

**解决方案：**

- API 代码中已经设置了 CORS 头
- 如果还有问题，检查 API 代码中的 CORS 设置

### Q3: Supabase 连接失败

**解决方案：**

1. 检查环境变量是否正确设置
2. 检查 Supabase Project URL 和 Key 是否正确
3. 确保已重新部署项目（环境变量修改后需要重新部署）

### Q4: 上传成功但数据丢失

**原因：**

- 如果使用基础版 API（`levels.js`），数据存储在内存中
- Serverless Functions 是无状态的，重启后会丢失

**解决方案：**

- 切换到 Supabase 版本，数据会持久化到数据库

### Q5: 如何更新 API 地址？

**解决方案：**

1. 在编辑器中点击 **"配置 API"**
2. 输入新的 API 地址
3. 点击确定即可

### Q6: 如何查看上传的关卡？

**解决方案：**

- **基础版**: 无法查看（内存存储）
- **Supabase 版**:
  1. 进入 Supabase Dashboard
  2. 打开 Table Editor
  3. 选择 `levels` 表
  4. 查看 `level_data` 列

---

## 🎉 完成！

现在你已经完成了所有配置，可以：

1. ✅ 在编辑器中编辑关卡
2. ✅ 一键上传到服务器
3. ✅ 数据持久化保存（如果使用 Supabase）
4. ✅ 其他玩家可以立即看到新关卡

## 📞 需要帮助？

如果遇到问题：

1. 检查浏览器控制台的错误信息（F12）
2. 检查 Vercel 部署日志
3. 检查 Supabase 日志（如果使用）

祝你使用愉快！🎮
